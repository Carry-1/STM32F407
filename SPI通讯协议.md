## **1.SPI协议简介**
&emsp;SPI(Serial Peripheral Interface)协议是由摩托罗拉公司提出的通讯协议,是一种高速全双工通信总线，被广泛使用于ADC、LCD等设备与MCU间，要求通讯速率较高的场合。
## **2.SPI物理层**
&emsp;SPI通讯使用3条总线(SCk、MOSI、MISO)外加一条片选线(SS、又常称为NSS、CS)。 每个从设备与主设备间都使用一条独立的片选线相连，当片选线为低电平时表示该从设备被选中。所有从设备的SCK、MOSI、MISO总线并联，仅当某从设备被选中时，其上述三根总线中传输的数据才有意义。
### **2.1片选线**
用于选中设备、低电平有效。
### **2.2 SCK(Serial Clock)**
时钟信号线，用于通讯数据同步
### **2.3 MOSI(Master Output Slave Input)**
主设备输出，从设备输入
### **2.3 MISO(Master Input Slave Output)**
主设备输入，从设备输出
      
*NSS、SCK、MOSI信号都由主机产生，MISO信号由从机产生。*

## **3.SPI协议层**
与I2C协议类似，SPI协议定义了通讯的起始和停止信号、数据有效性、时钟同步环节。
### **3.1SPI基本通讯过程**
&emsp;&emsp;NSS信号由高变低，是通讯的起始信号，由低变高，是通讯停止信号。   
&emsp;&emsp;SPI使用MOSI及MISO信号线传输数据，每个SCK周期传输一位数据，且 ***数据的输入输出同步进行*** 。对于MSB先行还是LSB先行无硬性规定，一般采用MSB先行。   
&emsp;&emsp;SPI每次可传输8位或16位数据(通讯起始信号和通讯停止信号之间)，具体传输的单位数不受限制。
### **3.2CPOL、CPHA及通讯模式**
&emsp;&emsp;SPI有四种通讯模式，他们的主要区别是**总线空闲时的SCK时钟状态以及数据采样时刻。**   
&emsp;&emsp;CPOL即时钟极性，指SPI通讯设备处于空闲状态时，SCK信号线的电平状态(即SPI通讯开始前、NSS信号线处于高电平时)CPOL=0时，SCK在空闲状态时为低电平，CPOL=1时，相反。    
&emsp;&emsp;CPHA即时钟相位，指时钟采样时刻，CPHA=0时，MOSI或MISO数据信号线上的信号会在SCK时钟线的“奇数边沿”采样。CPHA=1时，在“偶数边沿”采样。
## **4.STM32的SPI外设简介**
&emsp;&emsp;STM32的SPI外设可作为通讯的主机或从机。支持最高的SCK时钟频率为fpclk/2.它还支持双线全双工、双线单向及单线模式。我们常用的双线全双工模式。    
&emsp;&emsp;STM32芯片有多个SPI外设，它们的通讯信号引出到不同的GPIO引脚上，使用时必须配置到这些指定的引脚。
## **5.STM32作为SPI主设备的通讯过程**
1.控制NSS信号线产生通讯起始信号(实际开发过程中，常用GPIO引脚模拟产生通讯起始信号)    
2.把要发送的数据写入"数据寄存器DR"中，该数据会被缓存至发送缓冲区中    
3.通讯开始，SCK时钟开始运行，MOSI信号线将发送缓冲区的数据一位一位地发送出去，MISO则把数据一位一位地接收进接收缓冲区(双线全双工)    
4.当发送完一帧数据(8位或16位)，“状态寄存器SR”中的“TXE标志位”会被置1，表示发送缓冲区为空，此时如果还要发送数据，则再将数据写到数据寄存器DR中，同样地，当接收完一帧数据后，“RXNE标志位”会被置1，表示接收缓冲区不空，可以通过读取数据寄存器DR获取接收缓冲区中的内容。
&emsp;&emsp;若我们使能了TXE和RXNE中断，则标志位为1时，会触发中断，转入中断服务函数。
## 参考文献：《STM32库开发实战指南》